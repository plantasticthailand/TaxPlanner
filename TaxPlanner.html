<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมวางแผนและคำนวณภาษีเงินได้บุคคลธรรมดา</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-field { width: 100%; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; transition: border-color 0.2s; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px solid #3b82f6; }
        .input-disabled { background-color: #e2e8f0; color: #64748b; border-color: #cbd5e1; cursor: not-allowed; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .alert-modal { display: none; position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .tax-step-row:nth-child(even) { background-color: #f9fafb; }
        .details-panel { display: none; background-color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; border: 1px solid #e2e8f0; font-size: 0.85rem; color: #475569; }
        .details-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar for table */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-calculator mr-2"></i>วางแผนภาษีเงินได้บุคคลธรรมดา</h1>
            <div class="text-sm">ปีภาษี 2567/2568</div>
        </div>
    </nav>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-6">
        
        <!-- Left Column: Inputs -->
        <div class="flex-1">
            
            <!-- 1. Income Section -->
            <div class="card">
                <h2 class="section-title text-blue-600"><i class="fa-solid fa-money-bill-wave mr-2"></i>1. รายได้ (พ.ง.ด. 90/91)</h2>
                <div class="space-y-4" id="income-container">
                    <!-- Income inputs generated by JS -->
                </div>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-800">
                    <p><i class="fa-solid fa-info-circle mr-1"></i> ระบบจะคำนวณการหักค่าใช้จ่ายให้อัตโนมัติตามกฎหมายกำหนด</p>
                </div>
            </div>

            <!-- 2. Deductions Section -->
            <div class="card">
                <h2 class="section-title text-green-600"><i class="fa-solid fa-hand-holding-dollar mr-2"></i>2. ค่าลดหย่อน</h2>
                
                <div class="grid grid-cols-12 gap-2 mb-2 font-semibold text-sm text-center bg-gray-100 p-2 rounded">
                    <div class="col-span-6 text-left pl-2">รายการ</div>
                    <div class="col-span-3">มีอยู่แล้ว</div>
                    <div class="col-span-3 text-blue-600">แผนซื้อเพิ่ม</div>
                </div>

                <div id="deduction-container" class="space-y-3">
                    <!-- Deduction inputs generated by JS -->
                </div>

                <!-- Custom Deductions Section -->
                <div class="mt-6 border-t pt-4">
                    <label class="block font-medium text-gray-700 mb-2">รายการลดหย่อนเพิ่มเติม (กำหนดเอง)</label>
                    <div id="custom-deduction-container" class="space-y-2">
                        <!-- Custom rows will go here -->
                    </div>
                    <button onclick="addCustomDeduction()" class="mt-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded inline-flex items-center transition">
                        <i class="fa-solid fa-plus mr-2"></i> เพิ่มรายการลดหย่อนอื่นๆ
                    </button>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-sm text-yellow-800">
                    <p><i class="fa-solid fa-triangle-exclamation mr-1"></i> กลุ่มเกษียณ (RMF, SSF, กบข., ประกันบำนาญ, สงเคราะห์ครู) รวมกันต้องไม่เกิน 500,000 บาท</p>
                </div>
            </div>

            <!-- 3. Donations Section -->
            <div class="card">
                <h2 class="section-title text-purple-600"><i class="fa-solid fa-heart mr-2"></i>3. เงินบริจาค</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">บริจาคการศึกษา/กีฬา/โรงพยาบาล (ลดหย่อน 2 เท่า)</label>
                            <input type="number" id="donation_2x" class="input-field text-right" placeholder="0" oninput="calculateTax()">
                            <p class="text-xs text-gray-500 mt-1">* หักได้ไม่เกิน 10% ของเงินได้หลังหักค่าใช้จ่ายและค่าลดหย่อน</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">บริจาคทั่วไป (มูลนิธิ/วัด) (ลดหย่อน 1 เท่า)</label>
                            <input type="number" id="donation_1x" class="input-field text-right" placeholder="0" oninput="calculateTax()">
                            <p class="text-xs text-gray-500 mt-1">* หักได้ไม่เกิน 10% ของเงินได้สุทธิที่เหลือ</p>
                        </div>
                    </div>
                </div>
            </div>

             <!-- 4. Withholding Tax -->
             <div class="card">
                <h2 class="section-title text-gray-600"><i class="fa-solid fa-file-invoice-dollar mr-2"></i>4. ภาษีหัก ณ ที่จ่าย</h2>
                <div>
                    <label class="block text-sm font-medium mb-1">ภาษีที่ถูกหักไว้แล้วทั้งปี</label>
                    <input type="number" id="withholding_tax" class="input-field text-right bg-gray-50 border-gray-300" placeholder="0" oninput="calculateTax()">
                </div>
            </div>

        </div>

        <!-- Right Column: Dashboard (Sticky on Desktop) -->
        <div class="w-full lg:w-96 flex-shrink-0">
            <div class="sticky top-20 space-y-4">
                
                <!-- Tax Summary Card -->
                <div class="bg-gray-800 text-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2">สรุปภาษีที่ต้องจ่าย</h3>
                    
                    <!-- Basic Info -->
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-300 text-sm">เงินได้สุทธิ</span>
                        <span class="text-xl font-mono" id="display_net_income">0</span>
                    </div>

                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-300 text-sm">ภาษีที่คำนวณได้</span>
                        <span class="text-xl font-mono text-yellow-400" id="display_calculated_tax">0</span>
                    </div>

                    <div class="flex justify-between items-end mb-4 border-b border-gray-600 pb-4">
                        <span class="text-gray-300 text-sm">หัก ณ ที่จ่าย</span>
                        <span class="text-xl font-mono text-red-300" id="display_wht">-0</span>
                    </div>

                    <!-- Tax Saved Section (New) -->
                    <div class="bg-gray-700 rounded-lg p-3 mb-4 text-center border border-gray-600">
                        <span class="text-green-400 text-sm block mb-1"><i class="fa-solid fa-piggy-bank mr-1"></i>ภาษีที่ประหยัดได้ (จากการวางแผน)</span>
                        <span class="text-2xl font-bold text-green-300" id="display_tax_saved">0.00</span>
                    </div>

                    <!-- Final Status Section -->
                    <div class="mt-2">
                        <div id="status_payable_container" class="hidden text-center">
                            <span class="block text-gray-400 text-sm mb-1">ภาษีที่ต้องจ่ายเพิ่ม</span>
                            <span class="block text-4xl font-bold text-red-400" id="display_payable">0.00</span>
                            <span class="block text-xs text-gray-400 mt-2">บาท</span>
                        </div>
                        
                        <div id="status_refund_container" class="hidden text-center">
                            <span class="block text-gray-400 text-sm mb-1">ภาษีที่ได้คืน</span>
                            <span class="block text-4xl font-bold text-green-400" id="display_refund">0.00</span>
                            <span class="block text-xs text-gray-400 mt-2">บาท</span>
                        </div>

                        <div id="status_balance_container" class="text-center">
                            <span class="block text-gray-400 text-sm mb-1">ยอดสุทธิ</span>
                            <span class="block text-4xl font-bold text-gray-400">0.00</span>
                            <span class="block text-xs text-gray-400 mt-2">ไม่ต้องจ่ายเพิ่ม / ไม่ได้คืน</span>
                        </div>
                    </div>
                </div>

                <!-- Tax Bracket Table -->
                <div class="card overflow-hidden p-0">
                    <div class="p-4 bg-gray-100 border-b">
                        <h3 class="font-bold text-gray-700">ฐานภาษีขั้นบันได</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-200 text-gray-600">
                                <tr>
                                    <th class="p-2 text-left">เงินได้สุทธิ</th>
                                    <th class="p-2">อัตรา</th>
                                    <th class="p-2">ภาษี</th>
                                </tr>
                            </thead>
                            <tbody id="tax_step_body">
                                <!-- Steps generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Modal for Warnings -->
    <div id="alert_modal" class="alert-modal">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fa-solid fa-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal_title">แจ้งเตือน</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500" id="modal_message">ข้อความแจ้งเตือน</p>
                </div>
                <div class="mt-5">
                    <button onclick="closeModal()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                        ตกลง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Definitions ---

        const incomeTypes = [
            { 
                id: '40_1', label: '40(1) เงินเดือน โบนัส', 
                desc: 'หักเหมา 50% ไม่เกิน 100,000 (รวมกับ 40(2))',
                details: '<strong>การหักค่าใช้จ่าย:</strong> หักเหมาได้ 50% แต่รวมกับเงินได้ประเภทที่ 2 แล้วต้องไม่เกิน 100,000 บาท<br><strong>ตัวอย่าง:</strong> เงินเดือน, โบนัส, เบี้ยเลี้ยง, บำเหน็จบำนาญ'
            },
            { 
                id: '40_2', label: '40(2) ค่าจ้าง รับทำงาน', 
                desc: 'หักเหมา 50% ไม่เกิน 100,000 (รวมกับ 40(1))',
                details: '<strong>การหักค่าใช้จ่าย:</strong> หักเหมาได้ 50% แต่รวมกับเงินได้ประเภทที่ 1 แล้วต้องไม่เกิน 100,000 บาท<br><strong>ตัวอย่าง:</strong> ค่านายหน้า, ค่าธรรมเนียม, ค่าเบี้ยประชุม, ค่ารับทำงานให้'
            },
            { 
                id: '40_3', label: '40(3) ค่าลิขสิทธิ์', 
                desc: 'หักเหมา 50% ไม่เกิน 100,000',
                details: '<strong>การหักค่าใช้จ่าย:</strong> หักเหมาได้ 50% ไม่เกิน 100,000 บาท หรือเลือกหักตามจริง (ถ้ามีหลักฐาน)'
            },
            { 
                id: '40_4', label: '40(4) ดอกเบี้ย เงินปันผล', 
                desc: 'หักค่าใช้จ่ายไม่ได้ (มักเลือกเสียภาษีสุดท้าย 10-15%)',
                details: '<strong>การหักค่าใช้จ่าย:</strong> กฎหมายไม่ให้หักค่าใช้จ่าย<br><strong>ข้อแนะนำ:</strong> ดอกเบี้ย/เงินปันผลมักถูกหัก ณ ที่จ่าย 10-15% ไว้แล้ว (Final Tax) หากฐานภาษีคุณสูงกว่า 15% ไม่ควรนำมารวมคำนวณ'
            },
            { 
                id: '40_5', label: '40(5) ค่าเช่า', 
                desc: 'หักเหมา 10-30% ตามประเภททรัพย์สิน',
                details: '<strong>การหักค่าใช้จ่ายแบบเหมา:</strong><br>- บ้าน/โรงเรือน/สิ่งปลูกสร้าง: 30%<br>- ที่ดินเกษตร: 20%<br>- ที่ดินอื่นๆ: 15%<br>- ยานพาหนะ: 30%<br><em>*หรือเลือกหักตามจริง</em>'
            },
            { 
                id: '40_6', label: '40(6) วิชาชีพอิสระ', 
                desc: 'โรคศิลปะ 60%, อื่นๆ 30%',
                details: '<strong>การหักค่าใช้จ่ายแบบเหมา:</strong><br>- ประกอบโรคศิลปะ (แพทย์): 60%<br>- กฎหมาย, วิศวกรรม, สถาปัตยกรรม, บัญชี, ประณีตศิลปกรรม: 30%<br><em>*หรือเลือกหักตามจริง</em>'
            },
            { 
                id: '40_7', label: '40(7) รับเหมา (มีค่าของ)', 
                desc: 'หักเหมา 60%',
                details: '<strong>การหักค่าใช้จ่าย:</strong> หักเหมาได้ 60% หรือเลือกหักตามจริง (ต้องทำบัญชี)<br><strong>เงื่อนไข:</strong> ต้องเป็นการรับจ้างทำของโดยผู้รับจ้างเป็นผู้จัดหาวัสดุทั้งหมดหรือส่วนสำคัญ'
            },
            { 
                id: '40_8', label: '40(8) ธุรกิจ พาณิชย์ อื่นๆ', 
                desc: 'หักเหมา 60% (หรือตามจริง)',
                details: '<strong>การหักค่าใช้จ่าย:</strong> หักเหมา 60% (สำหรับ 43 ประเภทกิจการที่กฎหมายกำหนด) หรือหักตามจริง<br><strong>ตัวอย่าง:</strong> ขายของออนไลน์, ร้านอาหาร, ขายอสังหาฯ, นักแสดงสาธารณะ'
            }
        ];

        const deductions = [
            { 
                id: 'personal_allowance', label: 'ส่วนตัว', limit: 60000, group: 'personal', locked: true, value: 60000,
                details: 'ค่าลดหย่อนส่วนบุคคล 60,000 บาท (สำหรับผู้มีเงินได้ทุกคน)'
            },
            { 
                id: 'spouse', label: 'คู่สมรส (ไม่มีเงินได้)', limit: 60000, group: 'personal', 
                details: 'หักลดหย่อนได้ 60,000 บาท สำหรับคู่สมรสที่จดทะเบียนสมรสและไม่มีเงินได้ในปีภาษีนั้น'
            },
            { 
                id: 'child', label: 'บุตร (คนละ 30,000)', limit: 999999, group: 'personal', note: 'ใส่จำนวนเงินรวม',
                details: 'บุตรชอบด้วยกฎหมาย หรือบุตรบุญธรรม<br>- คนละ 30,000 บาท<br>- บุตรชอบด้วยกฎหมายคนที่ 2 ขึ้นไป (เกิดปี 2561 เป็นต้นไป) หักได้เพิ่มเป็นคนละ 60,000 บาท<br><strong>เงื่อนไข:</strong> อายุไม่เกิน 25 ปี (ศึกษาอยู่) หรือเป็นผู้เยาว์'
            },
            { 
                id: 'parent', label: 'บิดามารดา (คนละ 30,000)', limit: 120000, group: 'personal', note: 'อายุ 60 ปีขึ้นไป',
                details: 'หักได้คนละ 30,000 บาท (พ่อ 30k + แม่ 30k = 60k)<br><strong>เงื่อนไข:</strong><br>1. อายุ 60 ปีขึ้นไป<br>2. มีรายได้ไม่เกิน 30,000 บาท/ปี<br>3. ลูกใช้สิทธิ์ได้เพียงคนเดียว (ห้ามหาร)'
            },
            { 
                id: 'social_security', label: 'ประกันสังคม', limit: 9000, group: 'personal', note: 'สูงสุด 750/เดือน',
                details: 'หักตามจริงที่จ่ายเข้ากองทุนประกันสังคม สูงสุดไม่เกิน 9,000 บาท (ปี 2567 อาจมีการปรับลดอัตราส่งเงินสมทบในบางเดือน ต้องเช็คประกาศรัฐ)'
            },
            
            { 
                id: 'life_insurance', label: 'เบี้ยประกันชีวิต', limit: 100000, group: 'insurance',
                details: 'กรมธรรม์ 10 ปีขึ้นไป หักได้ตามจริงแต่ไม่เกิน 100,000 บาท'
            },
            { 
                id: 'health_insurance', label: 'เบี้ยประกันสุขภาพ', limit: 25000, group: 'insurance', note: 'รวมประกันชีวิตไม่เกิน 100,000',
                details: 'หักได้ตามจริงไม่เกิน 25,000 บาท<br><strong>สำคัญ:</strong> เมื่อรวมกับเบี้ยประกันชีวิตทั่วไปแล้ว ต้องไม่เกิน 100,000 บาท'
            },
            
            { 
                id: 'provident_fund', label: 'กองทุนสำรองเลี้ยงชีพ (PVD)', limit: 500000, limitPct: 15, group: 'retirement',
                details: 'หักได้ตามจริง ไม่เกิน 15% ของค่าจ้าง และไม่เกิน 500,000 บาท (เมื่อรวมกับกลุ่มเกษียณอื่นๆ)'
            },
            { 
                id: 'gpf', label: 'กบข.', limit: 500000, limitPct: 30, group: 'retirement',
                details: 'หักได้ตามจริง ไม่เกิน 30% ของเงินได้ และไม่เกิน 500,000 บาท (เมื่อรวมกับกลุ่มเกษียณอื่นๆ)'
            },
            { 
                id: 'rmf', label: 'RMF', limit: 500000, limitPct: 30, group: 'retirement',
                details: 'หักได้ตามจริง ไม่เกิน 30% ของเงินได้ และไม่เกิน 500,000 บาท (เมื่อรวมกับกลุ่มเกษียณอื่นๆ)<br>เงื่อนไข: ต้องซื้อต่อเนื่องทุกปี (เว้นได้ไม่เกิน 1 ปี) ถือครองอย่างน้อย 5 ปี และอายุครบ 55 ปี'
            },
            { 
                id: 'ssf', label: 'SSF', limit: 200000, limitPct: 30, group: 'retirement',
                details: 'หักได้ตามจริง ไม่เกิน 30% ของเงินได้ และไม่เกิน 200,000 บาท<br>เงื่อนไข: ถือครอง 10 ปีเต็ม (นับวันชนวัน) *นับรวมในวงเงิน 500,000 บาทของกลุ่มเกษียณด้วย'
            },
            { 
                id: 'pension_insurance', label: 'ประกันบำนาญ', limit: 200000, limitPct: 15, group: 'retirement',
                details: 'หักได้ 15% ของเงินได้ ไม่เกิน 200,000 บาท<br>เงื่อนไข: ต้องใช้วงเงิน 100,000 แรกของประกันชีวิตทั่วไปให้เต็มก่อน หรือจะใช้ส่วนนี้เลยก็ได้ แต่รวมกลุ่มเกษียณต้องไม่เกิน 500,000 บาท'
            },
            { 
                id: 'thaiesg', label: 'ThaiESG', limit: 300000, limitPct: 30, group: 'thaiesg',
                details: 'กองทุนลดหย่อนภาษีใหม่ (ปี 2567 เพิ่มวงเงิน)<br>หักได้ 30% ของเงินได้ ไม่เกิน 300,000 บาท<br>ระยะเวลาถือครอง: 5 ปี (จากเดิม 8 ปี) นับจากวันที่ซื้อ<br><strong>*แยกวงเงินต่างหาก ไม่รวมในกลุ่มเกษียณ 500,000</strong>'
            },
            
            { 
                id: 'loan_interest', label: 'ดอกเบี้ยบ้าน', limit: 100000, group: 'property',
                details: 'ดอกเบี้ยเงินกู้ยืมเพื่อที่อยู่อาศัย ตามจริงไม่เกิน 100,000 บาท (ถ้ากู้ร่วม ให้หารตามจำนวนผู้กู้ แต่รวมกันไม่เกิน 100,000)'
            },
            { 
                id: 'shop_dee', label: 'Easy E-Receipt (ปี 67)', limit: 50000, group: 'stimulus',
                details: 'โครงการ Easy E-Receipt (1 ม.ค. - 15 ก.พ. 2567)<br>ลดหย่อนได้ตามจริง สูงสุด 50,000 บาท<br>ต้องมีใบกำกับภาษีอิเล็กทรอนิกส์ (e-Tax Invoice) เท่านั้น'
            }
        ];

        let customDeductionCount = 0;

        // --- Initialization ---

        function init() {
            renderIncomeInputs();
            renderDeductionInputs();
            calculateTax();
        }

        function toggleDetails(id) {
            const el = document.getElementById(`details_${id}`);
            if (el.classList.contains('active')) {
                el.classList.remove('active');
            } else {
                el.classList.add('active');
            }
        }

        function renderIncomeInputs() {
            const container = document.getElementById('income-container');
            incomeTypes.forEach(type => {
                const html = `
                    <div class="border-b border-gray-100 pb-2 last:border-0">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <label class="block font-medium text-gray-700">${type.label}</label>
                                    <button onclick="toggleDetails('inc_${type.id}')" class="text-xs text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-2 py-0.5 rounded transition">
                                        <i class="fa-solid fa-circle-info mr-1"></i>เงื่อนไข
                                    </button>
                                </div>
                                <span class="text-xs text-gray-500 block mt-1">${type.desc}</span>
                            </div>
                            <div class="w-full sm:w-48 relative">
                                <input type="number" id="inc_${type.id}" class="input-field text-right pr-8" placeholder="0" oninput="calculateTax()">
                                <span class="absolute right-3 top-2 text-gray-400 text-sm">฿</span>
                            </div>
                        </div>
                        <div id="details_inc_${type.id}" class="details-panel">
                            ${type.details}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderDeductionInputs() {
            const container = document.getElementById('deduction-container');
            deductions.forEach(item => {
                const note = item.note ? `<div class="text-[10px] text-gray-400">${item.note}</div>` : '';
                
                // Logic for locked inputs (Personal Allowance)
                const isLocked = item.locked === true;
                const existVal = isLocked ? item.value : '';
                const existClass = isLocked ? 'input-field text-right text-sm px-1 input-disabled' : 'input-field text-right text-sm px-1';
                const existAttr = isLocked ? 'disabled' : `onchange="validateDeduction(this, '${item.id}')"`;
                
                const planClass = isLocked ? 'input-field text-right text-sm px-1 input-disabled' : 'input-field text-right text-sm px-1 border-blue-200 bg-blue-50 focus:bg-white';
                const planAttr = isLocked ? 'disabled' : `onchange="validateDeduction(this, '${item.id}')"`;

                const html = `
                    <div class="border-b border-gray-50 pb-2 last:border-0">
                        <div class="grid grid-cols-12 gap-2 items-center">
                            <div class="col-span-6 pl-2">
                                <div class="flex flex-wrap items-center gap-2">
                                    <div class="text-sm font-medium text-gray-700 truncate" title="${item.label}">${item.label}</div>
                                    <button onclick="toggleDetails('ded_${item.id}')" class="text-[10px] text-gray-500 hover:text-blue-600 bg-gray-100 px-1.5 py-0.5 rounded cursor-pointer">
                                        <i class="fa-solid fa-chevron-down"></i> เงื่อนไข
                                    </button>
                                </div>
                                ${note}
                            </div>
                            <div class="col-span-3">
                                <input type="number" id="ded_exist_${item.id}" value="${existVal}" data-limit="${item.limit}" data-group="${item.group}" 
                                    class="${existClass}" placeholder="0" ${existAttr}>
                            </div>
                            <div class="col-span-3">
                                <input type="number" id="ded_plan_${item.id}" data-limit="${item.limit}" data-group="${item.group}" 
                                    class="${planClass}" placeholder="0" ${planAttr}>
                            </div>
                        </div>
                        <div id="details_ded_${item.id}" class="details-panel ml-2 mr-2">
                            ${item.details}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- Custom Deduction Logic ---

        function addCustomDeduction() {
            customDeductionCount++;
            const container = document.getElementById('custom-deduction-container');
            const id = `custom_ded_${customDeductionCount}`;
            
            const html = `
                <div class="grid grid-cols-12 gap-2 items-center animate-fade-in" id="row_${id}">
                    <div class="col-span-6 pl-2">
                        <input type="text" placeholder="ระบุชื่อรายการ" class="input-field text-sm px-2" value="รายการเพิ่มเติม ${customDeductionCount}">
                    </div>
                    <div class="col-span-3">
                         <input type="number" id="${id}" class="input-field text-right text-sm px-1 custom-deduction-amount" placeholder="0" oninput="calculateTax()">
                    </div>
                    <div class="col-span-3 flex items-center gap-2">
                        <div class="w-full h-8 bg-gray-100 rounded border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-400">
                           -
                        </div>
                        <button onclick="removeCustomDeduction('${id}')" class="text-red-400 hover:text-red-600">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeCustomDeduction(id) {
            const row = document.getElementById(`row_${id}`);
            row.remove();
            calculateTax();
        }

        // --- Core Logic ---

        function getVal(id) {
            const el = document.getElementById(id);
            return el ? parseFloat(el.value) || 0 : 0;
        }

        function validateDeduction(input, id) {
            const val = parseFloat(input.value) || 0;
            const item = deductions.find(d => d.id === id);
            
            if (val > item.limit) {
                showModal('เกินสิทธิ์ที่กฎหมายกำหนด', `รายการ "${item.label}" กำหนดให้หักลดหย่อนได้ไม่เกิน ${item.limit.toLocaleString()} บาท`);
                input.value = item.limit;
                input.classList.add('bg-red-50', 'text-red-600');
                setTimeout(() => input.classList.remove('bg-red-50', 'text-red-600'), 2000);
            }

            calculateTax();
        }

        function showModal(title, message) {
            document.getElementById('modal_title').innerText = title;
            document.getElementById('modal_message').innerText = message;
            const modal = document.getElementById('alert_modal');
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('alert_modal').style.display = 'none';
        }

        function calculateScenario(incomeAfterExp, totalIncome, includePlan) {
            // Helper function to calculate tax for a given scenario (Base or Total)
            
            let totalDeduction = 0;
            let dedMap = {};

            // 1. Sum Deductions
            deductions.forEach(d => {
                let val = getVal(`ded_exist_${d.id}`);
                if (includePlan && !d.locked) {
                    val += getVal(`ded_plan_${d.id}`);
                }
                dedMap[d.id] = val;
            });

            // Specific Rules checks
            let life = Math.min(dedMap['life_insurance'], 100000);
            let health = Math.min(dedMap['health_insurance'], 25000);
            let insuranceTotal = Math.min(life + health, 100000);

            // Retirement Group
            let pvd = Math.min(dedMap['provident_fund'], totalIncome * 0.15);
            let gpf = Math.min(dedMap['gpf'], totalIncome * 0.30);
            let rmf = Math.min(dedMap['rmf'], totalIncome * 0.30);
            let ssf = Math.min(dedMap['ssf'], totalIncome * 0.30);
            let pension = Math.min(dedMap['pension_insurance'], totalIncome * 0.15);

            pvd = Math.min(pvd, 500000);
            rmf = Math.min(rmf, 500000);
            ssf = Math.min(ssf, 200000);
            pension = Math.min(pension, 200000);

            let retirementSum = pvd + gpf + rmf + ssf + pension;
            retirementSum = Math.min(retirementSum, 500000);

            let thaiesg = Math.min(dedMap['thaiesg'], totalIncome * 0.30);
            thaiesg = Math.min(thaiesg, 300000);

            let spouse = dedMap['spouse'];
            let child = dedMap['child'];
            let parent = dedMap['parent'];
            let ss = dedMap['social_security'];
            let interest = dedMap['loan_interest'];
            let shop = dedMap['shop_dee'];
            let personal = dedMap['personal_allowance'];

            totalDeduction += personal + spouse + child + parent + ss + insuranceTotal + retirementSum + thaiesg + interest + shop;

            // Custom Deductions (Always included as they don't have Plan column in UI currently, effectively 'exist')
            let customTotal = 0;
            const customInputs = document.querySelectorAll('.custom-deduction-amount');
            customInputs.forEach(input => {
                customTotal += parseFloat(input.value) || 0;
            });
            totalDeduction += customTotal;

            let incomeBeforeDonation = Math.max(0, incomeAfterExp - totalDeduction);

            // 2. Donations
            let don2x_raw = getVal('donation_2x');
            let don2x_limit = incomeBeforeDonation * 0.10;
            let don2x_actual = Math.min(don2x_raw, don2x_limit);
            let deduction_don2x = don2x_actual * 2;

            let incomeForDon1x = incomeBeforeDonation - deduction_don2x;
            
            let don1x_raw = getVal('donation_1x');
            let don1x_limit = incomeForDon1x * 0.10;
            let don1x_actual = Math.min(don1x_raw, don1x_limit);

            let netIncome = incomeForDon1x - don1x_actual;
            if (netIncome < 0) netIncome = 0;

            // 3. Tax Calculation
            const steps = [
                { max: 150000, rate: 0 },
                { max: 300000, rate: 0.05 },
                { max: 500000, rate: 0.10 },
                { max: 750000, rate: 0.15 },
                { max: 1000000, rate: 0.20 },
                { max: 2000000, rate: 0.25 },
                { max: 5000000, rate: 0.30 },
                { max: Infinity, rate: 0.35 }
            ];

            let tax = 0;
            let remainingIncome = netIncome;
            let prevMax = 0;
            
            steps.forEach((step) => {
                if (netIncome > prevMax) {
                     let taxableInLevel = Math.min(netIncome, step.max) - prevMax;
                     if (taxableInLevel < 0) taxableInLevel = 0;
                     tax += taxableInLevel * step.rate;
                }
                prevMax = step.max;
            });

            return { tax, netIncome };
        }

        function calculateTax() {
            // 1. Calculate Total Income & Expenses (Common for both scenarios)
            let totalIncome = 0;
            let totalExpenses = 0;

            const inc1 = getVal('inc_40_1');
            const inc2 = getVal('inc_40_2');
            const inc3 = getVal('inc_40_3');
            const inc4 = getVal('inc_40_4');
            const inc5 = getVal('inc_40_5');
            const inc6 = getVal('inc_40_6');
            const inc7 = getVal('inc_40_7');
            const inc8 = getVal('inc_40_8');

            totalIncome = inc1 + inc2 + inc3 + inc4 + inc5 + inc6 + inc7 + inc8;

            const exp1_2 = Math.min((inc1 + inc2) * 0.5, 100000);
            const exp3 = Math.min(inc3 * 0.5, 100000);
            const exp4 = 0; 
            const exp5 = inc5 * 0.30; 
            const exp6 = inc6 * 0.30; 
            const exp7 = inc7 * 0.60;
            const exp8 = inc8 * 0.60;

            totalExpenses = exp1_2 + exp3 + exp4 + exp5 + exp6 + exp7 + exp8;
            const incomeAfterExp = totalIncome - totalExpenses;

            // 2. Calculate Scenarios
            // Scenario A: Existing Only (For Tax Saved calculation)
            const resultBase = calculateScenario(incomeAfterExp, totalIncome, false);
            
            // Scenario B: Total (Existing + Plan) (For Final Display)
            const resultTotal = calculateScenario(incomeAfterExp, totalIncome, true);

            const tax = resultTotal.tax;
            const netIncome = resultTotal.netIncome;
            const taxSaved = Math.max(0, resultBase.tax - resultTotal.tax);

            // 3. Render Tax Steps (Based on Total Scenario)
            const steps = [
                { max: 150000, rate: 0 },
                { max: 300000, rate: 0.05 },
                { max: 500000, rate: 0.10 },
                { max: 750000, rate: 0.15 },
                { max: 1000000, rate: 0.20 },
                { max: 2000000, rate: 0.25 },
                { max: 5000000, rate: 0.30 },
                { max: Infinity, rate: 0.35 }
            ];

            const stepTableBody = document.getElementById('tax_step_body');
            stepTableBody.innerHTML = ''; 
            let prevMax = 0;
            let remainingIncome = netIncome;

            steps.forEach((step, index) => {
                let stepAmount = 0;
                let stepTax = 0;
                
                if (netIncome > prevMax) {
                     let taxableInLevel = Math.min(netIncome, step.max) - prevMax;
                     if (taxableInLevel < 0) taxableInLevel = 0;
                     stepTax = taxableInLevel * step.rate;
                     stepAmount = taxableInLevel;
                }

                const rangeLabel = step.max === Infinity ? `${(prevMax+1).toLocaleString()}+` : `${(prevMax+1).toLocaleString()} - ${step.max.toLocaleString()}`;
                const rowClass = stepAmount > 0 ? "bg-blue-50 font-medium text-blue-700" : "text-gray-400";
                const rowHtml = `
                    <tr class="border-b border-gray-100 ${rowClass}">
                        <td class="p-2 text-left">${rangeLabel}</td>
                        <td class="p-2">${(step.rate * 100).toFixed(0)}%</td>
                        <td class="p-2">${stepTax.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    </tr>
                `;
                stepTableBody.insertAdjacentHTML('beforeend', rowHtml);
                prevMax = step.max;
            });

            // 4. Final Summary
            const wht = getVal('withholding_tax');
            const finalBalance = tax - wht;

            document.getElementById('display_net_income').innerText = netIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('display_calculated_tax').innerText = tax.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('display_wht').innerText = wht > 0 ? "-" + wht.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : "0";
            
            document.getElementById('display_tax_saved').innerText = taxSaved.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Display logic for Payable/Refund
            const payableContainer = document.getElementById('status_payable_container');
            const refundContainer = document.getElementById('status_refund_container');
            const balanceContainer = document.getElementById('status_balance_container');
            const displayPayable = document.getElementById('display_payable');
            const displayRefund = document.getElementById('display_refund');

            payableContainer.classList.add('hidden');
            refundContainer.classList.add('hidden');
            balanceContainer.classList.add('hidden');

            if (finalBalance > 0) {
                // ต้องจ่ายเพิ่ม
                displayPayable.innerText = finalBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                payableContainer.classList.remove('hidden');
            } else if (finalBalance < 0) {
                // ได้คืน
                displayRefund.innerText = Math.abs(finalBalance).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                refundContainer.classList.remove('hidden');
            } else {
                // พอดี
                balanceContainer.classList.remove('hidden');
            }
        }

        window.addEventListener('DOMContentLoaded', init);
        
        window.onclick = function(event) {
            const modal = document.getElementById('alert_modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

    </script>
</body>
</html>